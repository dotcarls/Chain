!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.fence=e()}(this,function(){"use strict";function t(t,e,r,n){this._name=t,this._fn=e,this._args=r?Array.prototype.slice.call(r):[],this._memoize=!0===n,this._memoize&&this.memoize()}function e(t,e,r){this._invokables=t,this._results=e,this._subject=r}function r(t){this._invokables=t}function n(t){this._invokables=t?t.slice():[]}return t.prototype.invoke=function(){for(var t=this._fn,e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];var i=r.concat(this._args);return this._memoize&&this._memoizedFn&&(t=this._memoizedFn,i=[this._fn].concat(i)),t.apply(this,i)},t.prototype.memoize=function(){Object.defineProperty(this,"_cache",{value:{},writable:!1,configurable:!0,enumerable:!1});var t=function t(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];var o=n[0],s=t.cache;if(s[o])return s[o];var a=e.apply(e,n);return s[o]=a,a};t.cache=this._cache,this._memoizedFn=t},t.prototype.dememoize=function(){delete this._cache,delete this._memoizedFn,this._memoize=!1},t.prototype.serialize=function(t){if(!0===t)return JSON.stringify(this);var e={_name:this._name,_args:this._args,_memoize:this._memoize};return JSON.stringify(e)},e.prototype.forAll=function(){return this._results.reduce(function(t,e){return Array.isArray(e)?t&&e.reduce(function(t,e){return t&&e.forAll()},t):t&&!0===e},!0)},e.prototype.forAny=function(){return this._results.reduce(function(t,e){return Array.isArray(e)?t||!0===e.reduce(function(t,e){return t||e.forAny()},t):t||!0===e},!1)},e.prototype.forOne=function(t){var e=this._invokables;return this._results.filter(function(r,n){return e[n].getName()===t})},e.prototype.explain=function(t,e){t=t||console.log,e=e||"  ",t(e,"subject:",JSON.stringify(this._subject)),t(e+e,this.forAll()?"[✓]":"[x]","forAll"),t(e+e,this.forAny()?"[✓]":"[x]","forAny"),t(e,"tests:");for(var r=0;r<this._results.length;r++){var n=this._results[r],i=this._invokables[r],o=i._name,s=i._args,a=o;s.length>0&&(a+=" ("+JSON.stringify(s)+")"),t(e+e,n?"[✓]":"[x]",a),Array.isArray(n)&&n.forEach(function(r){r.explain(t,e+e)})}},r.prototype.run=function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];var i=this._invokables;return new e(i,i.map(function(t){return t.invoke.apply(t,r)}),r)},n.prototype.fork=function(t){t=t||Object.getPrototypeOf(this);var e=this._invokables,r=function(){n.call(this,e)};return r.prototype=Object.create(t),r.prototype.constructor=r,new r},n.prototype.register=function(e,r,n,i,o){var s=Object.getPrototypeOf(this);return s[e]=function(){return this._invokables.push(new t(e,r,arguments,n,i,o)),this},this.fork(s)},n.prototype.unregister=function(t){var e=Object.getPrototypeOf(this);delete e[t];var r=this.fork(e);return r._invokables=this._invokables.filter(function(e){return e.getName()!==t}),r},n.prototype.build=function(){return new r(this._invokables)},n.prototype.serialize=function(t){return JSON.stringify(this._invokables.map(function(e){return e.serialize(t)}))},n.prototype.hydrate=function(t){var e=this.fork();return e._invokables=[],JSON.parse(t).map(JSON.parse).forEach(function(t){var r=t._name,n=t._args,i=Object.getPrototypeOf(e)[r];if(!i)throw new Error("Method "+r+" missing during validation builder hydration");i.apply(e,n)}),e},n});
